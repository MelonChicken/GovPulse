# PRD — “PolitePing(가칭)” 최소 구조 스냅샷 모니터 (Claude Code용)

## 1) 목표

* 공공 웹 서비스 대표 엔드포인트에 **저부하 요청**을 보내 **현재 상태 스냅샷**을 즉시 표시합니다.
* **저장/DB 없음**, 재시작 시 상태 초기화.
* “무한 로딩/지연” 상황을 단순 휴리스틱으로 표기합니다.

## 2) 핵심 제약(저부하 원칙)

* **엔드포인트 화이트리스트만** 점검(자동 링크 추적 금지).
* **도메인당 ≤ 1 req/min**, **엔드포인트당 ≤ 1 req/10 min**(초기값).
* 전체 동시성 **3**, 호스트당 동시성 **1**.
* **HEAD 우선 → 필요 시 GET 최소 청크 1회**만 읽고 중단.
* 타임아웃(초기값): connect 5s, read 8s, total 12s.
* `User-Agent` 명시, `robots.txt`·약관 준수. 금지·옵트아웃 요청 수신 시 즉시 제외.

## 3) 범위 / 비범위

* 범위

  * 대표 엔드포인트 3~5개(메인/안내 등) 대상으로 **스냅샷 상태** 표시.
  * `/snapshot` JSON과 `/` 단일 HTML로 **즉시 가시화**.
* 비범위

  * 인증 필요한 내부망/개인정보 취급 페이지 모니터링.
  * 대량 크롤링/부하 테스트/침투 테스트.
  * 과거 히스토리 저장·추세 그래프.

## 4) 사용자 시나리오

* 운영/보안 담당자: 지금 시점의 정상/지연/오류 여부를 한눈에 확인.
* 일반 사용자: 복구 상황이 “정상으로 보이는지” 즉시 확인.

## 5) 아키텍처(최소형)

* **단일 파일**: `main.py` (FastAPI + httpx)
* 엔드포인트 목록: 코드 상수(`ENDPOINTS`)로 보관(필요 시 `ENDPOINTS.json`로 분리 가능).
* 프런트: `/`에서 JS가 **60초마다** `/snapshot` 호출해 카드 UI로 표시.
* 상태 캐시 없음(레이트 제한을 위한 **마지막 점검 시각**만 메모리 기록).

## 6) 요청 정책(판정 로직 포함)

* 요청 순서: **HEAD → (405/403 등 필요 시) GET(stream, 1 청크만)**.
* 상태 분류

  * **OK**: 2xx, 첫 바이트(TTFB) ≤ 8s.
  * **UNSTABLE**: 2xx이나 TTFB > 8s(지연·무한 로딩 추정).
  * **TIMEOUT_CONNECT / TIMEOUT_READ**: 각 단계 타임아웃.
  * **CONN_ERROR/DNS/TLS/TRANSPORT_ERROR**: 연결·인증·전송 계층 오류.
  * **HTTP4xx/HTTP5xx**: 상태코드 기반 장애.
  * **SKIPPED**: 레이트 제한으로 점검 생략(최근 결과 대신 건너뜀).
* “무한 로딩” 휴리스틱: **TTFB > 8s** 또는 스트리밍 지속 징후가 1회 이상 → `UNSTABLE`.

## 7) API/응답 형식

* `GET /`

  * 단일 HTML. JS가 `/snapshot`을 60초마다 호출. 카드 그리드 표시.
* `GET /snapshot`

  * JSON 배열. 각 요소 필드:

    * `name`: 엔드포인트 표시명
    * `url`: 점검 URL
    * `http`: HTTP 상태코드(없으면 `null`)
    * `ttfb_ms`: 최초 바이트까지 소요(ms, 부동소수점 반올림)
    * `outcome`: `OK|UNSTABLE|SKIPPED|TIMEOUT_*|HTTP*|CONN_ERROR|DNS|TLS|TRANSPORT_ERROR|ERROR`
    * `error`: 에러 요약 문자열(선택)
    * `ts`: UNIX epoch(sec)

## 8) 설정값(초기)

* 간격: 클라이언트 폴링 **60s**.
* 레이트: 도메인당 **≤ 1 req/min**, 엔드포인트당 **≤ 1 req/10 min**.
* 동시성: 전체 **3**, 호스트당 **1**.
* 타임아웃: connect **5s**, read **8s**, total **12s**.
* TTFB SLA: **8s**.
* `User-Agent`: `GovPublicStatusMonitor/1.0 (+연락처)`

## 9) 로깅

* 표준 출력에 한 줄 JSON 또는 단순 텍스트로 요청 결과·레이트 제한 이벤트 기록.
* 민감 데이터(본문·쿠키) 미기록.

## 10) 보안·윤리

* PII·폼 제출·파일 다운로드 금지.
* `robots.txt`·사이트 정책 준수.
* 기관의 차단·문의 수신 시 즉각 중지 및 화이트리스트 수정.

## 11) 초기 작업(우선순위)

1. `main.py` 생성(FastAPI, `/`, `/snapshot`).
2. httpx AsyncClient + 세마포어(전체·호스트당) 구현.
3. 레이트 제한(도메인/엔드포인트별 마지막 점검 시각) 구현.
4. HEAD→GET(단일 청크) 판정 로직구현 + 결과 JSON 스키마 확정.
5. 프런트 단일 HTML(카드 UI, outcome 색상).
6. 엔드포인트 3~5개로 PoC 실행.
7. 레이트·동시성·타임아웃이 의도대로 작동하는지 로컬에서 검증.

## 12) 수용 기준(Acceptance)

* `/snapshot` 호출 시 각 엔드포인트에 대해 `outcome/http/ttfb_ms`가 반환됩니다.
* 1분 내 반복 호출 시 **도메인당 1 req/min** 규칙으로 일부 엔드포인트는 `SKIPPED`가 반환됩니다.
* 네트워크 지연/차단을 모의했을 때 `UNSTABLE` 또는 `TIMEOUT_*` 등으로 올바르게 분류됩니다.
* 서버는 **DB 없이** 구동되며, 재시작하면 레이트 기록이 초기화됩니다.
* 동시 실행 중에도 **전체 3, 호스트당 1** 동시성 제한이 유지됩니다.

## 13) 리스크·대응

* **봇 차단/WAF**: User-Agent 명시, 요청률 엄수. 차단 시 해당 엔드포인트 비활성화.
* **콘텐츠 변경**: HEAD가 막히면 GET 1청크 폴백. 안내 페이지 문구 변경 시에도 상태 분류는 TTFB/응답코드 중심으로 유지.
* **과도한 폴링**: 폴링 주기·레이트 제한을 설정값으로 노출하여 쉽게 완화.